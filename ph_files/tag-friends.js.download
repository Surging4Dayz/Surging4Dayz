var commentParent=[],friendList=[];function prepareTagging(){$j(".js_tagTextarea").parent("div").addClass("js_taggableContainer"),$j(".js_taggableContainer").each(function(){$j(this).find(".js_taggable").length<1&&($j(this).find(".js_tagTextarea").before('<div data-placeholder="Share what you think" contenteditable="true" tabindex="0" maxlength="500" class="js_taggable taggablePlaceholder"></div>'),$j(".js_tagTextarea").hide(),$j(this).find(".js_taggable").addClass("ui-autocomplete-input"))})}function syncCharacterCount(e){var t=500-e.find(".js_taggable").text().length-1;e.closest("form").find("input.countdownCharacters").html(t),e.closest("form").find("input.countdownCharacters").val(t)}function autocompleteDone(e,t,a){commentParent.find(".js_taggable").autocomplete("destroy");var n=e;-1==friendList.indexOf(n)&&friendList.push(n);var r=$j(".tagTrigger").text(),i=commentParent.find(".js_taggable").text(),o=commentParent.find(".js_taggable").caret();i.substring(i.length-r.length,i.length),o-=r.length,i=i.substring(0,o)+i.substring(o+r.length,i.length);var g=String("@"+e),m=o+g.length+1,s=$j("html.firefox");g=" "+g+(0<a.length||0<s.length?"&nbsp;":" ");var c=[i.slice(0,o),g,i.slice(o)].join("");commentParent.find(".js_taggable").html(c),$j(".currentTag").removeClass("currentTag"),startOfTag=null,$j(".tagTrigger").remove(),commentParent.removeAttr("tagenabled"),commentParent.find(".js_taggable").focus(),m++,commentParent.find(".js_taggable").caret(m)}function pushCommentData(e){var t=e.closest("form").find(".js_tagTextarea");commentTyper=e.closest("form").find(".js_taggable").text();var a=commentTyper.split(/[\s,]+/);$j.map(friendList,function(e){if(-1!=a.indexOf("@"+e)){var t=new RegExp("@"+e,"g");commentTyper=commentTyper.replace(t,"#*@"+e+"*#")}});var n=new RegExp("<(\"[^\"]*?\"|'[^']*?'|[^'\">])*>","gi");commentTyper.match(n)&&(commentTyper=commentTyper.sanitize()),t.html(""),t.val(""),t.text(""),t.html(commentTyper),t.val(commentTyper),t.text(commentTyper)}head.ready(document,function(){var e=$j(".js_taggable"),c=e.closest(".js_taggableContainer").find(".js_taggable > *:last-child"),a=(String(e.html()),$j(".chrome, .safari")),t=$j(".firefox"),n=$j(".ie11"),r=$j(".ie"),l=0;function d(e){var t=String(e.find(".js_taggable").html());c.is(".tagTrigger")||e.find(".js_tagTextarea").val(t)}function h(){var n=commentParent.find("span.tagTrigger").text(),e=0<a.length?2:1,t=-1==l?1:e;if(n=n.substring(t,n.length),$j(".currentTag").autocomplete({minLength:1,appendTo:commentParent,focus:function(){return!1},source:function(e,t){if(commentParent.attr("tagenabled")){n=n||"";var a=String("/chat/friends_json?search="+n);$j.ajax({url:a,dataType:"json",success:function(e){t($j.map(e,function(e){return{username:e.username,avatar:e.avatar,userId:e.id}}))}})}},select:function(e,t){autocompleteDone(t.item.username,t.item.userId,a),commentParent.removeAttr("tagenabled"),n=null}}),!commentParent.attr("tagenabled"))return!1;commentParent.find(".currentTag").data()&&(commentParent.find(".currentTag").data("ui-autocomplete")._renderItem=function(e,t){if(commentParent.attr("tagenabled"))return $j('<li class="listedFriend"></li>').append('<a><img class="listedFriendAvatar" src='+t.avatar+' /><span class="listedFriendUsername">'+t.username+"</span></a>").data("ui-autocomplete-item",t).appendTo(e)})}0<a.length?$j(document).on("keydown",".js_taggable",function(e){$j(this).addClass("currentTag"),commentParent=$j(this).parent("div.js_taggableContainer");var t="37"==e.which?"":decodeURI(String.fromCharCode(e.which)),a=e.keyCode||e.charCode,n=String($j(this).html()),r=(c.html(),n.slice(-1)),i=$j(this).caret()+1,o=$j(this).text(),g=l?o.substring(l,i)+t:"";if(37!=a&&39!=a||!$j(".taggablePlaceholder ").hasClass("activeEdit")||e.stopPropagation(),!e.shiftKey||50!=a||""!==r&&";"!==r){if(8==e.which)if("@"==r)commentParent.find(".tagTrigger").remove(),commentParent.removeAttr("tagenabled"),l=null,$j(".currentTag").removeClass("currentTag"),commentParent.find(".js_taggable").autocomplete("destroy");else{var m=g;m=m.substring(0,m.length-2),commentParent.find(".tagTrigger").html(m)}else if(46==a);else if(32==a&&commentParent.attr("tagenabled"))commentParent.removeAttr("tagenabled"),commentParent.find(".js_taggable").autocomplete("destroy"),commentParent.find(".tagTrigger").remove();else if(38==e.which||40==e.which);else if(189==a&&commentParent.attr("tagenabled"));else if(commentParent.attr("tagenabled")){commentParent.find(".tagTrigger").html();var s=String.fromCharCode(a);s=s.toLowerCase(),commentParent.find(".tagTrigger").html(g)}}else commentParent.attr("tagenabled","true"),l=$j(this).caret()-1,commentParent.find(".tagTrigger").remove(),commentParent.append('<span class="tagTrigger">@</span>');d(commentParent),commentParent.attr("tagenabled")&&h(),syncCharacterCount(commentParent)}):0<t.length||0<r.length||0<n.length?$j(document).on("keydown",".js_taggable",function(e){var t=e.keyCode||e.charCode;37!=t&&39!=t||!$j(".taggablePlaceholder ").hasClass("activeEdit")||e.stopPropagation()}):$j(document).on("keypress",".js_taggable",function(e){$j(this).addClass("currentTag"),commentParent=$j(this).parent("div.js_taggableContainer");var t=String.fromCharCode(e.which),a=e.keyCode||e.charCode,n=String($j(this).text()),r=(c.html(),n.slice(-1)),i=$j(this).caret()+1,o=$j(this).text(),g=l?o.substring(l,i)+t:"";if("@"!==t||""!=r&&" "!=r&&";"!=r)if(8==a)if("@"===r)commentParent.find(".tagTrigger").remove(),commentParent.removeAttr("tagenabled"),l=null,$j(".currentTag").removeClass("currentTag"),commentParent.find(".js_taggable").autocomplete("destroy");else{var m=g;m=m.substring(0,m.length-2),commentParent.find(".tagTrigger").html(m)}else 46==a||(32==a&&commentParent.attr("tagenabled")?(commentParent.removeAttr("tagenabled"),commentParent.find(".js_taggable").autocomplete("destroy"),commentParent.find(".tagTrigger").remove()):38==e.which||40==e.which||commentParent.attr("tagenabled")&&commentParent.find(".tagTrigger").html(g));else commentParent.attr("tagenabled","true"),l=$j(this).caret()-1,commentParent.find(".tagTrigger").remove(),commentParent.append('<span class="tagTrigger">'+t+"</span>");d(commentParent),commentParent.attr("tagenabled")&&h(),syncCharacterCount(commentParent)}),prepareTagging(),renderCommentLinks(),$j(".js_taggableContainer").find(".js_taggable").blur(function(e){e.stopPropagation(),d($j(this))}),$j(".js_taggableContainer").find(".js_taggable").focus(function(e){e.stopPropagation(),$j(".js_taggableContainer").siblings("div.actions").show(),$j(".js_taggableContainer").siblings("div.actions #postComment").attr("disabled",!1)}),$j('div.actions input[type~="submit"], .streamSubmitInput').click(function(e){e.preventDefault();$j(this)})});